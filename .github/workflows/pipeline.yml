name: Sentinel CI Pipeline

on:
  push:
    branches: [ "main", "develop", "feature/**" ] # ğŸ†• å»ºè­°åŠ å…¥ feature/** è®“åˆ†æ”¯ä¹Ÿèƒ½è·‘æ¸¬è©¦
  pull_request:
    branches: [ "main" ]

jobs:
  # === Job 1: å“è³ªæª¢æŸ¥èˆ‡å–®å…ƒæ¸¬è©¦ (Host Machine) ===
  quality-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake gcc cppcheck

      # ğŸ†•ã€æ–°å¢ã€‘ç¢ºä¿ Unity å­˜åœ¨ (é˜²å‘†æ©Ÿåˆ¶)
      # å¦‚æœä½ çš„ lib/unity å·²ç¶“åœ¨ repo è£¡ï¼Œé€™æ­¥æœƒè‡ªå‹•è·³éï¼›å¦‚æœä¸åœ¨ï¼Œå®ƒæœƒæ•‘ä½ ä¸€å‘½ã€‚
      - name: Ensure Unity Exists
        run: |
          if [ ! -d "lib/unity" ]; then
            echo "Unity not found, cloning..."
            git clone https://github.com/ThrowTheSwitch/Unity.git lib/unity
          else
            echo "Unity already exists."
          fi

      # ğŸ†•ã€æ–°å¢ã€‘ç¢ºä¿ Mock Headers è³‡æ–™å¤¾çµæ§‹å­˜åœ¨
      # é¿å…å› ç‚ºç©ºè³‡æ–™å¤¾æ²’è¢« git å‚³ä¸Šå»è€Œå°è‡´ç·¨è­¯å¤±æ•—
      - name: Ensure Mock Headers Structure
        run: |
          mkdir -p test/mock_headers/pico
          mkdir -p test/mock_headers/hardware
          touch test/mock_headers/pico/stdlib.h
          touch test/mock_headers/hardware/uart.h
          touch test/mock_headers/hardware/dma.h
          touch test/mock_headers/hardware/irq.h

      - name: ğŸ” Static Analysis (Cppcheck)
        run: |
          cppcheck --enable=warning,performance,portability \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            -I src/app -I src/hal \
            --error-exitcode=1 src/

      - name: ğŸ§ª Build & Run Unit Tests
        run: |
          chmod +x build.sh
          # é€™è£¡æœƒåŸ·è¡Œæˆ‘å€‘åœ¨ CMakeLists.txt è¨­å®šå¥½çš„ ctest
          ./build.sh -t --clean

  # === Job 2: éŸŒé«”ç·¨è­¯æ¸¬è©¦ (Target Machine) ===
  build-firmware:
    needs: quality-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          submodules: recursive # è¨˜å¾—é€™è£¡ä¹Ÿè¦åŠ ï¼Œæœ‰äº›é©…å‹•å¯èƒ½åœ¨ submodule

      - name: Install ARM Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential cmake

      - name: ğŸ“¥ Clone Pico SDK
        run: |
          git clone -b master https://github.com/raspberrypi/pico-sdk.git
          cd pico-sdk
          git submodule update --init
          # è¨­å®šç’°å¢ƒè®Šæ•¸ä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
          echo "PICO_SDK_PATH=$PWD" >> $GITHUB_ENV

      - name: ğŸ”¨ Build Firmware (Dry Run)
        run: |
          # é€™è£¡æ‰‹å‹•è·‘ cmake ä»¥ç¢ºä¿æ§åˆ¶æ¬Š
          mkdir -p build_firmware
          cd build_firmware
          # æŒ‡å‘ä¸Šä¸€å±¤çš„ CMakeLists.txt
          cmake -DPICO_BOARD=pico2_w -DPICO_SDK_PATH=${{ env.PICO_SDK_PATH }} ..
          make -j2