name: Sentinel CI Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # === Job 1: å“è³ªæª¢æŸ¥èˆ‡å–®å…ƒæ¸¬è©¦ (Host Machine) ===
  quality-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake gcc cppcheck

      - name: ğŸ” Static Analysis (Cppcheck)
        run: |
          # é€™è£¡ä½¿ç”¨äº†æˆ‘å€‘å‰›å‰›å„ªåŒ–éçš„æŒ‡ä»¤
          cppcheck --enable=warning,performance,portability \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            -I src/app -I src/hal \
            --error-exitcode=1 src/

      - name: ğŸ§ª Build & Run Unit Tests
        run: |
          chmod +x build.sh
          ./build.sh -t

  # === Job 2: éŸŒé«”ç·¨è­¯æ¸¬è©¦ (Target Machine) ===
  build-firmware:
    needs: quality-and-test # æ¸¬è©¦éäº†æ‰å‡†ç·¨è­¯éŸŒé«”
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install ARM Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential cmake

      - name: ğŸ“¥ Clone Pico SDK
        run: |
          git clone -b master https://github.com/raspberrypi/pico-sdk.git
          echo "PICO_SDK_PATH=$PWD/pico-sdk" >> $GITHUB_ENV

      - name: ğŸ”¨ Build Firmware (Dry Run)
        run: |
          # æ¨¡æ“¬çœŸå¯¦ç·¨è­¯ï¼Œç¢ºä¿æ²’æœ‰èªæ³•éŒ¯èª¤
          chmod +x build.sh
          # æ³¨æ„ï¼šæˆ‘å€‘ä¸çœŸçš„åŸ·è¡Œ build.sh (å› ç‚ºå®ƒé è¨­æœƒæœ‰ docker é‚è¼¯æˆ–æ˜¯æœ¬åœ°è·¯å¾‘ä¾è³´)
          # é€™è£¡æˆ‘å€‘ç›´æ¥ç”¨ cmake æ‰‹å‹•è·‘ï¼Œæ¯”è¼ƒç©©
          mkdir build
          cd build
          cmake -DPICO_BOARD=pico2_w ..
          make -j2